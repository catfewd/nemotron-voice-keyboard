name: Build Nemotron Voice Keyboard

on:
  push:
    tags:
      - 'v*'
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android

    - name: Install Android NDK r28
      run: |
        cd $ANDROID_HOME
        curl -L -O https://dl.google.com/android/repository/android-ndk-r28-linux.zip
        unzip -q android-ndk-r28-linux.zip
        rm android-ndk-r28-linux.zip
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/android-ndk-r28" >> $GITHUB_ENV
        TOOLCHAIN_BIN=$ANDROID_HOME/android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64/bin
        echo "$TOOLCHAIN_BIN" >> $GITHUB_PATH

    - name: Download Nemotron Model
      run: |
        mkdir -p assets/nemotron-model
        cd assets/nemotron-model
        curl -L -o encoder.onnx "https://huggingface.co/lokkju/nemotron-speech-streaming-en-0.6b-int8/resolve/main/encoder.onnx?download=true"
        curl -L -o decoder_joint.onnx "https://huggingface.co/lokkju/nemotron-speech-streaming-en-0.6b-int8/resolve/main/decoder_joint.onnx?download=true"
        curl -L -o tokenizer.model "https://huggingface.co/lokkju/nemotron-speech-streaming-en-0.6b-int8/resolve/main/tokenizer.model?download=true"

    - name: Configure Cargo for NDK
      run: |
        NDK_TOOLCHAIN=$ANDROID_HOME/android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64
        mkdir -p .cargo
        cat > .cargo/config.toml << CARGOEOF
        [target.aarch64-linux-android]
        linker = "$NDK_TOOLCHAIN/bin/aarch64-linux-android26-clang"
        rustflags = [
            "-C", "link-arg=--sysroot=$NDK_TOOLCHAIN/sysroot",
            "-C", "link-arg=-static-libstdc++",
            "-C", "link-arg=-L$GITHUB_WORKSPACE/jniLibs/arm64-v8a",
            "-C", "link-arg=-lonnxruntime",
            "-C", "link-arg=-llog"
        ]
        CARGOEOF


    - name: Patch ort-sys build script
      run: |
        cargo fetch --target aarch64-linux-android 2>/dev/null || true
        ORT_SYS=$(find ~/.cargo/registry/src -name "main.rs" -path "*/ort-sys*" 2>/dev/null | head -1)
        if [ -n "$ORT_SYS" ]; then
          python3 -c "
path = '$ORT_SYS'
with open(path, 'r') as f:
    lines = f.readlines()
lines[96] = '\t\tlet bin_extract_dir = std::path::PathBuf::from(\"/tmp/ort-cache\")\n'
lines[97] = '\t\t\t// patched\n'
with open(path, 'w') as f:
    f.writelines(lines)
print('Patched:', path)
"
        fi
        mkdir -p /tmp/ort-cache

    - name: Build Rust
      run: |
        export ORT_STRATEGY=system
        export ORT_LIB_LOCATION=$GITHUB_WORKSPACE/jniLibs/arm64-v8a
        export ORT_INCLUDE_DIR=$GITHUB_WORKSPACE/libs/onnxruntime/headers
        export ORT_SKIP_DOWNLOAD=1
        cargo build --target aarch64-linux-android --release

    - name: Build APK
      run: |
        PLATFORM=$ANDROID_HOME/platforms/android-33/android.jar
        BUILD_TOOLS=$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | tail -1)
        mkdir -p build_manual/gen build_manual/obj build_manual/apk build_manual/lib/arm64-v8a

        $BUILD_TOOLS/aapt2 compile --dir res -o build_manual/resources.zip
        $BUILD_TOOLS/aapt2 link -I $PLATFORM --manifest AndroidManifest.xml \
          -o build_manual/apk/unaligned.apk build_manual/resources.zip \
          --java build_manual/gen --auto-add-overlay

        find src/java -name "*.java" > build_manual/sources.txt
        find build_manual/gen -name "*.java" >> build_manual/sources.txt
        javac -d build_manual/obj -source 1.8 -target 1.8 \
          -classpath $PLATFORM @build_manual/sources.txt

        find build_manual/obj -name "*.class" > build_manual/classes.txt
        $BUILD_TOOLS/d8 --output build_manual/apk --lib $PLATFORM @build_manual/classes.txt

        cp target/aarch64-linux-android/release/libandroid_transcribe_app.so build_manual/lib/arm64-v8a/
        cp jniLibs/arm64-v8a/libonnxruntime.so build_manual/lib/arm64-v8a/

        cd build_manual/apk
        zip -g unaligned.apk classes.dex
        cp -r ../lib .
        zip -r0 unaligned.apk lib
        cd $GITHUB_WORKSPACE
        zip -r0 build_manual/apk/unaligned.apk assets/

        mkdir -p $HOME/.android
        keytool -genkey -v -keystore $HOME/.android/debug.keystore \
          -storepass android -alias androiddebugkey -keypass android \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -dname "CN=Android Debug, OU=Unknown, O=Unknown, C=US"

        $BUILD_TOOLS/zipalign -f -p -v 4 \
          build_manual/apk/unaligned.apk build_manual/apk/aligned.apk
        $BUILD_TOOLS/apksigner sign \
          --ks $HOME/.android/debug.keystore \
          --ks-pass pass:android --key-pass pass:android \
          --ks-key-alias androiddebugkey \
          --out Nemotron_Voice_Keyboard.apk build_manual/apk/aligned.apk

    - name: Create Release and Upload
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: Nemotron Voice Keyboard v0.1.14
        files: Nemotron_Voice_Keyboard.apk
